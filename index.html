<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #3B82F6;
            --success: #10B981;
            --error: #EF4444;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #1F2937;
            --border: #E2E8F0;
        }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Login Page */
        .login-box { max-width: 450px; margin: 80px auto; padding: 40px; background: var(--card); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .login-box h1 { text-align: center; color: var(--primary); margin-bottom: 10px; font-size: 28px; }
        .login-box .subtitle { text-align: center; color: #6B7280; margin-bottom: 30px; font-size: 14px; }
        
        /* Setup Notice */
        .setup-notice { background: #FEF3C7; border: 2px solid var(--warning); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .setup-notice h3 { color: var(--warning); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .setup-notice ol { margin-left: 20px; margin-top: 10px; }
        .setup-notice li { margin-bottom: 8px; font-size: 14px; }
        .setup-notice code { background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        
        /* Buttons */
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; font-family: inherit; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; justify-content: center; }
        .btn-primary:hover { background: #2563EB; transform: translateY(-2px); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; transform: translateY(-2px); }
        .btn-danger { background: var(--error); color: white; }
        .btn-danger:hover { background: #DC2626; transform: translateY(-2px); }
        .btn-secondary { background: var(--border); color: var(--text); }
        
        /* Status Badge */
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; margin-bottom: 20px; }
        .status-connected { background: #D1FAE5; color: var(--success); }
        .status-disconnected { background: #FEE2E2; color: var(--error); }
        
        /* App Container */
        .app { display: none; }
        .app.active { display: block; }
        
        /* Header */
        .header { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .header h1 { font-size: 24px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .header-controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .user-badge { padding: 8px 16px; background: rgba(59,130,246,0.1); border-radius: 20px; color: var(--primary); font-size: 14px; font-weight: 500; }
        
        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-4px); }
        .stat-label { font-size: 12px; text-transform: uppercase; opacity: 0.7; margin-bottom: 8px; }
        .stat-value { font-size: 36px; font-weight: 700; }
        .profit { color: var(--success); }
        .loss { color: var(--error); }
        
        /* Card */
        .card { background: var(--card); padding: 24px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card h2 { margin-bottom: 20px; display: flex; align-items: center; gap: 8px; font-size: 20px; }
        
        /* Tables */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--primary); color: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; }
        tbody tr:hover { background: rgba(59,130,246,0.05); }
        
        /* Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; background: var(--card); padding: 10px; border-radius: 12px; }
        .tab { padding: 10px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-family: inherit; font-size: 14px; font-weight: 500; }
        .tab:hover { background: rgba(59,130,246,0.1); }
        .tab.active { background: var(--primary); color: white; }
        
        /* Pages */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); border-radius: 16px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h3 { font-size: 22px; }
        
        /* Form Row */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        
        /* Action Buttons */
        .action-btn { padding: 6px; border: none; background: transparent; cursor: pointer; border-radius: 6px; color: var(--text); }
        .action-btn:hover { background: var(--border); }
        
        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; border-radius: 8px; color: white; font-weight: 500; display: flex; align-items: center; gap: 12px; z-index: 2000; animation: slideIn 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }
        .toast.warning { background: var(--warning); }
        
        /* Empty State */
        .empty { text-align: center; padding: 60px 20px; opacity: 0.5; }
        .empty .material-icons { font-size: 64px; margin-bottom: 16px; }
        
        /* Loading */
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 3px solid var(--border); border-top: 3px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: stretch; }
            .header-controls { justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-box">
        <h1>ðŸ“Š Trading Journal</h1>
        <p class="subtitle">Multi-user cloud-synced trading journal</p>
        
        <!-- Setup Instructions -->
        <div class="setup-notice" id="setupNotice">
            <h3>
                <span class="material-icons">info</span>
                Setup Required
            </h3>
            <p style="margin-bottom: 10px;">Before logging in, you need to:</p>
            <ol>
                <li>Deploy the Google Apps Script</li>
                <li>Copy the deployment URL</li>
                <li>Paste it in the input below</li>
                <li>Click "Save & Test Connection"</li>
            </ol>
        </div>
        
        <!-- API URL Setup -->
        <div class="form-group">
            <label>
                <span class="material-icons" style="font-size: 14px; vertical-align: middle;">cloud</span>
                Google Apps Script URL
            </label>
            <input type="url" id="apiUrlSetup" placeholder="https://script.google.com/macros/s/.../exec">
        </div>
        
        <button class="btn btn-primary" onclick="saveAndTestApi()" style="margin-bottom: 20px;">
            <span class="material-icons">sync</span>
            Save & Test Connection
        </button>
        
        <div id="connectionStatus" class="status-badge status-disconnected" style="display: none;">
            <span class="material-icons" style="font-size: 14px;">cloud_off</span>
            Not Connected
        </div>
        
        <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border);">
        
        <!-- Login Form -->
        <div id="loginForm" style="opacity: 0.5; pointer-events: none;">
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="email" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="name" placeholder="John Trader">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button class="btn btn-primary" onclick="login()">
                <span class="material-icons">login</span>
                Login / Register
            </button>
            <p style="text-align: center; font-size: 12px; margin-top: 16px; opacity: 0.6;">
                New users will be registered automatically
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="app">
        <div class="container">
            <div class="header">
                <h1>
                    <span class="material-icons">analytics</span>
                    Trading Journal
                </h1>
                <div class="header-controls">
                    <div class="user-badge" id="userBadge">
                        <span class="material-icons" style="font-size: 16px;">person</span>
                        <span id="userName">User</span>
                    </div>
                    <button class="btn btn-primary" onclick="openAddModal()">
                        <span class="material-icons">add</span>
                        Add Trade
                    </button>
                    <button class="btn btn-success" onclick="syncTrades()">
                        <span class="material-icons">sync</span>
                        Sync
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        <span class="material-icons">logout</span>
                        Logout
                    </button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showPage('dashboard')">
                    <span class="material-icons" style="font-size: 18px; vertical-align: middle;">dashboard</span>
                    Dashboard
                </button>
                <button class="tab" onclick="showPage('journal')">
                    <span class="material-icons" style="font-size: 18px; vertical-align: middle;">book</span>
                    Journal
                </button>
                <button class="tab" onclick="showPage('settings')">
                    <span class="material-icons" style="font-size: 18px; vertical-align: middle;">settings</span>
                    Settings
                </button>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="page active">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">Total P/L</div>
                        <div class="stat-value" id="totalPL">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value" id="winRate">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Trades</div>
                        <div class="stat-value" id="totalTrades">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Risk/Reward</div>
                        <div class="stat-value" id="rrRatio">0.00</div>
                    </div>
                </div>
                <div class="card">
                    <h2>
                        <span class="material-icons">show_chart</span>
                        Recent Trades
                    </h2>
                    <div id="recentTrades"></div>
                </div>
            </div>

            <!-- Journal -->
            <div id="journal" class="page">
                <div class="card">
                    <h2>
                        <span class="material-icons">table_chart</span>
                        All Trades
                    </h2>
                    <div class="table-wrapper" id="allTrades"></div>
                </div>
            </div>

            <!-- Settings -->
            <div id="settings" class="page">
                <div class="card">
                    <h2>
                        <span class="material-icons">cloud</span>
                        Google Apps Script Connection
                    </h2>
                    <div class="form-group">
                        <label>Deployment URL</label>
                        <input type="url" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec" readonly>
                    </div>
                    <button class="btn btn-success" onclick="testConnection()">
                        <span class="material-icons">sync</span>
                        Test Connection
                    </button>
                </div>
                <div class="card">
                    <h2>
                        <span class="material-icons">warning</span>
                        Danger Zone
                    </h2>
                    <p style="margin-bottom: 16px; color: var(--error);">This action cannot be undone!</p>
                    <button class="btn btn-danger" onclick="deleteAllTrades()">
                        <span class="material-icons">delete_forever</span>
                        Delete All My Trades
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Trade</h3>
                <button class="action-btn" onclick="closeModal()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="tradeForm" onsubmit="saveTrade(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="tradeDate" required>
                    </div>
                    <div class="form-group">
                        <label>Time *</label>
                        <input type="time" id="tradeTime" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Pair *</label>
                        <input type="text" id="tradePair" placeholder="EUR/USD" required>
                    </div>
                    <div class="form-group">
                        <label>Session *</label>
                        <select id="tradeSession" required>
                            <option value="">Select Session</option>
                            <option value="Asian">Asian</option>
                            <option value="European">European</option>
                            <option value="American">American</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="tradeType" required>
                            <option value="">Select Type</option>
                            <option value="Buy">Buy</option>
                            <option value="Sell">Sell</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Result *</label>
                        <select id="tradeResult" required>
                            <option value="">Select Result</option>
                            <option value="Win">Win</option>
                            <option value="Loss">Loss</option>
                            <option value="Breakeven">Breakeven</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Risk Amount ($)</label>
                        <input type="number" id="riskAmount" step="0.01" placeholder="100.00">
                    </div>
                    <div class="form-group">
                        <label>Reward Amount ($)</label>
                        <input type="number" id="rewardAmount" step="0.01" placeholder="300.00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="tradeNotes" rows="3" placeholder="Trade notes..."></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <span class="material-icons">save</span>
                        Save Trade
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let API_URL = '';
        let currentUser = null;
        let trades = [];
        let editingId = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved API URL
            API_URL = localStorage.getItem('apiUrl') || '';
            
            if (API_URL) {
                document.getElementById('apiUrlSetup').value = API_URL;
                document.getElementById('scriptUrl').value = API_URL;
                updateConnectionUI(true);
            }
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('user');
            if (savedUser && API_URL) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showApp();
                    syncTrades();
                } catch(e) {
                    console.error('Error loading saved user:', e);
                }
            }
        });

        // Save and test API connection
        async function saveAndTestApi() {
            const url = document.getElementById('apiUrlSetup').value.trim();
            
            if (!url) {
                showToast('Please enter the Google Apps Script URL', 'error');
                return;
            }
            
            if (!url.includes('script.google.com')) {
                showToast('Invalid URL. Must be a Google Apps Script URL', 'error');
                return;
            }
            
            showToast('Testing connection...', 'warning');
            
            try {
                const res = await fetch(url, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                const data = await res.json();
                
                if (data.status === 'success') {
                    API_URL = url;
                    localStorage.setItem('apiUrl', url);
                    document.getElementById('scriptUrl').value = url;
                    updateConnectionUI(true);
                    showToast('Connection successful! You can now login.', 'success');
                    document.getElementById('setupNotice').style.display = 'none';
                } else {
                    showToast('Connection failed. Check your deployment URL.', 'error');
                    updateConnectionUI(false);
                }
            } catch (error) {
                console.error('Connection error:', error);
                showToast('Connection failed: ' + error.message, 'error');
                updateConnectionUI(false);
            }
        }

        // Update connection UI
        function updateConnectionUI(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const loginForm = document.getElementById('loginForm');
            
            statusEl.style.display = 'flex';
            
            if (connected) {
                statusEl.className = 'status-badge status-connected';
                statusEl.innerHTML = '<span class="material-icons" style="font-size: 14px;">cloud_done</span> Connected';
                loginForm.style.opacity = '1';
                loginForm.style.pointerEvents = 'auto';
            } else {
                statusEl.className = 'status-badge status-disconnected';
                statusEl.innerHTML = '<span class="material-icons" style="font-size: 14px;">cloud_off</span> Not Connected';
                loginForm.style.opacity = '0.5';
                loginForm.style.pointerEvents = 'none';
            }
        }

        // Login function
        async function login() {
            const email = document.getElementById('email').value.trim();
            const name = document.getElementById('name').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !name || !password) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            if (!API_URL) {
                showToast('Please configure API connection first', 'error');
                return;
            }
            
            showToast('Logging in...', 'warning');
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'login',
                        email: email,
                        password: password,
                        name: name
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    currentUser = data.data;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showToast('Login successful!', 'success');
                    showApp();
                    await syncTrades();
                } else {
                    showToast('Login failed: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed: ' + error.message, 'error');
            }
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                trades = [];
                localStorage.removeItem('user');
                document.getElementById('app').classList.remove('active');
                document.getElementById('loginPage').style.display = 'block';
                showToast('Logged out successfully', 'success');
            }
        }

        // Show app
        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').classList.add('active');
            document.getElementById('userName').textContent = currentUser.name;
            updateDashboard();
        }

        // Show page
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            event.target.closest('.tab').classList.add('active');
            
            if (page === 'journal') renderJournal();
        }

        // Sync trades from cloud
        async function syncTrades() {
            if (!API_URL || !currentUser) return;
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'getUserTrades',
                        userId: currentUser.userId
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    trades = data.data || [];
                    updateDashboard();
                    renderJournal();
                    showToast(`Synced ${trades.length} trade${trades.length !== 1 ? 's' : ''}`, 'success');
                } else {
                    showToast('Sync failed: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showToast('Sync failed: ' + error.message, 'error');
            }
        }

        // Update dashboard statistics
        function updateDashboard() {
            const wins = trades.filter(t => t.result === 'Win').length;
            const losses = trades.filter(t => t.result === 'Loss').length;
            const total = trades.length;
            const winRate = total > 0 ? ((wins / total) * 100).toFixed(1) : 0;
            
            let totalPL = 0;
            let totalRisk = 0;
            let totalReward = 0;
            
            trades.forEach(t => {
                totalPL += parseFloat(t.profitLoss) || 0;
                if (t.riskAmount) totalRisk += parseFloat(t.riskAmount);
                if (t.rewardAmount && t.result === 'Win') totalReward += parseFloat(t.rewardAmount);
            });
            
            const rrRatio = totalRisk > 0 ? (totalReward / totalRisk).toFixed(2) : '0.00';
            
            document.getElementById('totalPL').textContent = '$' + totalPL.toFixed(2);
            document.getElementById('totalPL').className = 'stat-value ' + (totalPL >= 0 ? 'profit' : 'loss');
            document.getElementById('winRate').textContent = winRate + '%';
            document.getElementById('totalTrades').textContent = total;
            document.getElementById('rrRatio').textContent = rrRatio;
            
            renderRecent();
        }

        // Render recent trades
        function renderRecent() {
            const container = document.getElementById('recentTrades');
            const recent = [...trades]
                .sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time))
                .slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = '<div class="empty"><span class="material-icons">trending_up</span><p>No trades yet. Click "Add Trade" to get started!</p></div>';
                return;
            }
            
            container.innerHTML = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>
