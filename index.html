<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #3B82F6;
            --success: #10B981;
            --error: #EF4444;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #1F2937;
            --border: #E2E8F0;
        }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .login-box { max-width: 400px; margin: 100px auto; padding: 40px; background: var(--card); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .login-box h1 { text-align: center; color: var(--primary); margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; justify-content: center; }
        .btn-primary:hover { background: #2563EB; transform: translateY(-2px); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .app { display: none; }
        .app.active { display: block; }
        .header { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .header h1 { font-size: 24px; color: var(--primary); }
        .header-controls { display: flex; gap: 12px; flex-wrap: wrap; }
        .user-badge { padding: 8px 16px; background: rgba(59,130,246,0.1); border-radius: 20px; color: var(--primary); font-size: 14px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-label { font-size: 12px; text-transform: uppercase; opacity: 0.7; margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: 700; }
        .profit { color: var(--success); }
        .loss { color: var(--error); }
        .card { background: var(--card); padding: 24px; border-radius: 12px; margin-bottom: 20px; }
        .card h2 { margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--primary); color: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        tbody tr:hover { background: rgba(59,130,246,0.05); }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); border-radius: 16px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; border-radius: 8px; color: white; font-weight: 500; display: flex; align-items: center; gap: 12px; z-index: 2000; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }
        .empty { text-align: center; padding: 60px 20px; opacity: 0.5; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .tab:hover { background: rgba(59,130,246,0.1); }
        .tab.active { background: var(--primary); color: white; }
        .page { display: none; }
        .page.active { display: block; }
        .action-btn { padding: 6px; border: none; background: transparent; cursor: pointer; border-radius: 6px; }
        .action-btn:hover { background: var(--border); }
        @media (max-width: 768px) {
            .stats { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-box">
        <h1>ðŸ“Š Trading Journal</h1>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" placeholder="your@email.com">
        </div>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="name" placeholder="Your Name">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="btn btn-primary" onclick="login()">
            <span class="material-icons">login</span>
            Login / Register
        </button>
        <p style="text-align: center; font-size: 12px; margin-top: 16px; opacity: 0.6;">
            First time? You'll be registered automatically
        </p>
    </div>

    <!-- Main App -->
    <div id="app" class="app">
        <div class="container">
            <div class="header">
                <h1>ðŸ“Š Trading Journal</h1>
                <div class="header-controls">
                    <div class="user-badge" id="userBadge">User</div>
                    <button class="btn btn-primary" onclick="openAddModal()">
                        <span class="material-icons">add</span>
                        Add Trade
                    </button>
                    <button class="btn btn-success" onclick="syncTrades()">
                        <span class="material-icons">sync</span>
                        Sync
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        <span class="material-icons">logout</span>
                        Logout
                    </button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showPage('dashboard')">Dashboard</button>
                <button class="tab" onclick="showPage('journal')">Journal</button>
                <button class="tab" onclick="showPage('settings')">Settings</button>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="page active">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">Total P/L</div>
                        <div class="stat-value" id="totalPL">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value" id="winRate">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Trades</div>
                        <div class="stat-value" id="totalTrades">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Risk/Reward</div>
                        <div class="stat-value" id="rrRatio">0.00</div>
                    </div>
                </div>
                <div class="card">
                    <h2>Recent Trades</h2>
                    <div id="recentTrades"></div>
                </div>
            </div>

            <!-- Journal -->
            <div id="journal" class="page">
                <div class="card">
                    <h2>All Trades</h2>
                    <div id="allTrades"></div>
                </div>
            </div>

            <!-- Settings -->
            <div id="settings" class="page">
                <div class="card">
                    <h2>Google Apps Script URL</h2>
                    <div class="form-group">
                        <label>Deployment URL</label>
                        <input type="url" id="scriptUrl" placeholder="https://script.google.com/macros/s/YOUR_ID/exec">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    <button class="btn btn-success" onclick="testConnection()" style="margin-left: 10px;">Test Connection</button>
                </div>
                <div class="card">
                    <h2>Danger Zone</h2>
                    <button class="btn btn-danger" onclick="deleteAllTrades()">Delete All My Trades</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Trade</h3>
                <button class="action-btn" onclick="closeModal()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="tradeForm" onsubmit="saveTrade(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="tradeDate" required>
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="time" id="tradeTime" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Pair</label>
                        <input type="text" id="tradePair" placeholder="EUR/USD" required>
                    </div>
                    <div class="form-group">
                        <label>Session</label>
                        <select id="tradeSession" required>
                            <option value="">Select</option>
                            <option value="Asian">Asian</option>
                            <option value="European">European</option>
                            <option value="American">American</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="tradeType" required>
                            <option value="">Select</option>
                            <option value="Buy">Buy</option>
                            <option value="Sell">Sell</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Result</label>
                        <select id="tradeResult" required>
                            <option value="">Select</option>
                            <option value="Win">Win</option>
                            <option value="Loss">Loss</option>
                            <option value="Breakeven">Breakeven</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Risk Amount ($)</label>
                        <input type="number" id="riskAmount" step="0.01" placeholder="100.00">
                    </div>
                    <div class="form-group">
                        <label>Reward Amount ($)</label>
                        <input type="number" id="rewardAmount" step="0.01" placeholder="300.00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="tradeNotes" rows="3" placeholder="Trade notes..."></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn btn-danger" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <span class="material-icons">save</span>
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let API_URL = '';
        let currentUser = null;
        let trades = [];
        let editingId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            API_URL = localStorage.getItem('apiUrl') || '';
            const savedUser = localStorage.getItem('user');
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }
            
            if (API_URL) {
                document.getElementById('scriptUrl').value = API_URL;
            }
        });

        // Login
        async function login() {
            const email = document.getElementById('email').value.trim();
            const name = document.getElementById('name').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !name || !password) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            if (!API_URL) {
                showToast('Please configure API URL in settings first', 'error');
                showApp();
                showPage('settings');
                return;
            }
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', email, password, name })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    currentUser = data.data;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showApp();
                    await syncTrades();
                    showToast('Login successful!', 'success');
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('Login failed: ' + error.message, 'error');
            }
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                trades = [];
                localStorage.removeItem('user');
                document.getElementById('app').classList.remove('active');
                document.getElementById('loginPage').style.display = 'block';
                showToast('Logged out', 'success');
            }
        }

        // Show app
        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').classList.add('active');
            document.getElementById('userBadge').textContent = currentUser.name;
            updateDashboard();
        }

        // Show page
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            event.target.classList.add('active');
            
            if (page === 'journal') renderJournal();
        }

        // Sync trades
        async function syncTrades() {
            if (!API_URL || !currentUser) return;
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getUserTrades', userId: currentUser.userId })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    trades = data.data || [];
                    updateDashboard();
                    renderJournal();
                    showToast(`Synced ${trades.length} trades`, 'success');
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('Sync failed: ' + error.message, 'error');
            }
        }

        // Update dashboard
        function updateDashboard() {
            const wins = trades.filter(t => t.result === 'Win').length;
            const losses = trades.filter(t => t.result === 'Loss').length;
            const total = trades.length;
            const winRate = total > 0 ? ((wins / total) * 100).toFixed(1) : 0;
            
            let totalPL = 0;
            let totalRisk = 0;
            let totalReward = 0;
            
            trades.forEach(t => {
                totalPL += t.profitLoss || 0;
                if (t.riskAmount) totalRisk += parseFloat(t.riskAmount);
                if (t.rewardAmount && t.result === 'Win') totalReward += parseFloat(t.rewardAmount);
            });
            
            const rrRatio = totalRisk > 0 ? (totalReward / totalRisk).toFixed(2) : '0.00';
            
            document.getElementById('totalPL').textContent = '$' + totalPL.toFixed(2);
            document.getElementById('totalPL').className = 'stat-value ' + (totalPL >= 0 ? 'profit' : 'loss');
            document.getElementById('winRate').textContent = winRate + '%';
            document.getElementById('totalTrades').textContent = total;
            document.getElementById('rrRatio').textContent = rrRatio;
            
            renderRecent();
        }

        // Render recent trades
        function renderRecent() {
            const container = document.getElementById('recentTrades');
            const recent = [...trades].sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time)).slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = '<div class="empty">No trades yet</div>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Pair</th>
                            <th>Type</th>
                            <th>Result</th>
                            <th>P/L</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recent.map(t => `
                            <tr>
                                <td>${t.date}</td>
                                <td><strong>${t.pair}</strong></td>
                                <td>${t.type}</td>
                                <td style="color: ${t.result === 'Win' ? 'var(--success)' : t.result === 'Loss' ? 'var(--error)' : 'inherit'}">${t.result}</td>
                                <td class="${t.profitLoss >= 0 ? 'profit' : 'loss'}">$${t.profitLoss.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Render journal
        function renderJournal() {
            const container = document.getElementById('allTrades');
            
            if (trades.length === 0) {
                container.innerHTML = '<div class="empty">No trades yet</div>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Pair</th>
                            <th>Session</th>
                            <th>Type</th>
                            <th>Result</th>
                            <th>Risk</th>
                            <th>Reward</th>
                            <th>P/L</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trades.map(t => `
                            <tr>
                                <td>${t.date}</td>
                                <td>${t.time}</td>
                                <td><strong>${t.pair}</strong></td>
                                <td>${t.session}</td>
                                <td>${t.type}</td>
                                <td style="color: ${t.result === 'Win' ? 'var(--success)' : t.result === 'Loss' ? 'var(--error)' : 'inherit'}">${t.result}</td>
                                <td>$${(parseFloat(t.riskAmount) || 0).toFixed(2)}</td>
                                <td>$${(parseFloat(t.rewardAmount) || 0).toFixed(2)}</td>
                                <td class="${t.profitLoss >= 0 ? 'profit' : 'loss'}">$${t.profitLoss.toFixed(2)}</td>
                                <td>
                                    <button class="action-btn" onclick='editTrade(${JSON.stringify(t).replace(/'/g, "&#39;")})'>
                                        <span class="material-icons">edit</span>
                                    </button>
                                    <button class="action-btn" onclick="deleteTrade('${t.id}')">
                                        <span class="material-icons">delete</span>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Open add modal
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add Trade';
            document.getElementById('tradeForm').reset();
            document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('tradeTime').value = new Date().toTimeString().slice(0, 5);
            document.getElementById('tradeModal').classList.add('active');
        }

        // Edit trade
        function editTrade(trade) {
            editingId = trade.id;
            document.getElementById('modalTitle').textContent = 'Edit Trade';
            document.getElementById('tradeDate').value = trade.date;
            document.getElementById('tradeTime').value = trade.time;
            document.getElementById('tradePair').value = trade.pair;
            document.getElementById('tradeSession').value = trade.session;
            document.getElementById('tradeType').value = trade.type;
            document.getElementById('tradeResult').value = trade.result;
            document.getElementById('riskAmount').value = trade.riskAmount || '';
            document.getElementById('rewardAmount').value = trade.rewardAmount || '';
            document.getElementById('tradeNotes').value = trade.notes || '';
            document.getElementById('tradeModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('tradeModal').classList.remove('active');
            editingId = null;
        }

        // Save trade
        async function saveTrade(e) {
            e.preventDefault();
            
            const trade = {
                date: document.getElementById('tradeDate').value,
                time: document.getElementById('tradeTime').value,
                pair: document.getElementById('tradePair').value,
                session: document.getElementById('tradeSession').value,
                type: document.getElementById('tradeType').value,
                result: document.getElementById('tradeResult').value,
                riskAmount: document.getElementById('riskAmount').value,
                rewardAmount: document.getElementById('rewardAmount').value,
                notes: document.getElementById('tradeNotes').value
            };
            
            try {
                if (editingId) {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'updateTrade', userId: currentUser.userId, tradeId: editingId, trade })
                    });
                    
                    const data = await res.json();
                    if (data.success) {
                        showToast('Trade updated', 'success');
                    }
                } else {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'addTrade', userId: currentUser.userId, trade })
                    });
                    
                    const data = await res.json();
                    if (data.success) {
                        showToast('Trade added', 'success');
                    }
                }
                
                closeModal();
                await syncTrades();
            } catch (error) {
                showToast('Save failed: ' + error.message, 'error');
            }
        }

        // Delete trade
        async function deleteTrade(id) {
            if (!confirm('Delete this trade?')) return;
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'deleteTrade', userId: currentUser.userId, tradeId: id })
                });
                
                const data = await res.json();
                if (data.success) {
                    showToast('Trade deleted', 'success');
                    await syncTrades();
                }
            } catch (error) {
                showToast('Delete failed: ' + error.message, 'error');
            }
        }

        // Delete all trades
        async function deleteAllTrades() {
            if (!confirm('Delete ALL your trades? This cannot be undone!')) return;
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'deleteAllUserTrades', userId: currentUser.userId })
                });
                
                const data = await res.json();
                if (data.success) {
                    trades = [];
                    updateDashboard();
                    renderJournal();
                    showToast('All trades deleted', 'success');
                }
            } catch (error) {
                showToast('Delete failed: ' + error.message, 'error');
            }
        }

        // Save settings
        function saveSettings() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (url) {
                API_URL = url;
                localStorage.setItem('apiUrl', url);
                showToast('Settings saved', 'success');
            }
        }

        // Test connection
        async function testConnection() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (!url) {
                showToast('Enter API URL first', 'error');
                return;
            }
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.status === 'success') {
                    showToast('Connection successful!', 'success');
                } else {
                    showToast('Connection failed', 'error');
                }
            } catch (error) {
                showToast('Connection error: ' + error.message, 'error');
            }
        }

        // Show toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="material-icons">${type === 'success' ? 'check_circle' : 'error'}</span>${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
