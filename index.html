// Add this to your HTML file's JavaScript section

// Add download button to the settings page HTML:
/*
<div class="card">
    <h2>
        <span class="material-icons">download</span>
        Download Your Data
    </h2>
    <p>Export all your trading data as a CSV file for backup or analysis.</p>
    <button class="btn btn-success" id="downloadDataBtn">
        <span class="material-icons">file_download</span>
        Download My Data as CSV
    </button>
</div>
*/

// Add this function to download user data
async function downloadUserData() {
    if (!currentUser || !SCRIPT_URL) {
        showToast('Please login and configure connection first', 'error');
        return;
    }

    try {
        showToast('Preparing your data...', 'warning');
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'downloadUserData',
                userId: currentUser.userId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Create download link
            const blob = new Blob([result.data.csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = result.data.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('Data downloaded successfully!', 'success');
        } else {
            showToast('Download failed: ' + result.message, 'error');
        }
    } catch (error) {
        showToast('Download failed: ' + error.message, 'error');
    }
}

// Update the initializeEventListeners function to add this:
// document.getElementById('downloadDataBtn').addEventListener('click', downloadUserData);

// Update getAllUsers to require admin password
async function loadAllUsers() {
    if (!SCRIPT_URL) {
        showToast('Please configure Google Sheets connection first', 'error');
        return;
    }

    const adminPassword = localStorage.getItem('adminPassword');
    if (!adminPassword) {
        showToast('Please set admin password in settings first', 'error');
        navigateToPage('settings');
        return;
    }

    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'getAllUsers',
                adminPassword: adminPassword
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const users = result.data || [];
            localStorage.setItem('allUsers', JSON.stringify(users));
            renderUsersList(users);
        } else {
            showToast('Failed to load users: ' + result.message, 'error');
        }
    } catch (error) {
        showToast('Failed to load users: ' + error.message, 'error');
    }
}
